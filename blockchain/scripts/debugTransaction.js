const { ethers } = require("hardhat");

async function main() {
  // The failed transaction data from the logs
  const txData = "0x7600da8d00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000068d9b27f0000000000000000000000000000000000000000000000000000000068db03c300000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000047465737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000331323300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000027177000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000261730000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000464667663000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002637600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000156372756e6368797061616e40676d61696c2e636f6d0000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000b6c69746572616c6c797a6b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002a3078663764306130646538613361626233353232626532653865636630336162393961323938326439630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

  console.log("ðŸ” Debugging Failed Transaction...");
  console.log("Transaction Data:", txData);
  
  // Get the contract factory to decode
  const ElectionFactory = await ethers.getContractFactory("ElectionFactory");
  const iface = ElectionFactory.interface;
  
  try {
    // Decode the transaction data
    const decoded = iface.parseTransaction({ data: txData });
    console.log("\nðŸ“‹ Decoded Function Call:");
    console.log("Function:", decoded.name);
    console.log("Arguments:", decoded.args);
    
    console.log("\nðŸ—ï¸ Detailed Arguments:");
    console.log("_electionInfo:", {
      startTime: decoded.args[0].startTime.toString(),
      endTime: decoded.args[0].endTime.toString(), 
      name: decoded.args[0].name,
      description: decoded.args[0].description,
      isPrivate: decoded.args[0].isPrivate
    });
    
    console.log("_candidates:", decoded.args[1].map((c, i) => ({
      index: i,
      candidateID: c.candidateID.toString(),
      name: c.name,
      description: c.description
    })));
    
    console.log("_ballotType:", decoded.args[2].toString());
    console.log("_resultType:", decoded.args[3].toString());
    
    console.log("_whitelist:", decoded.args[4].map((w, i) => ({
      index: i,
      identifier: w.identifier,
      identifierType: w.identifierType.toString(),
      isActive: w.isActive
    })));
    
  } catch (error) {
    console.error("âŒ Failed to decode transaction:", error);
  }
  
  // Test the contract function call
  console.log("\nðŸ§ª Testing contract call...");
  const factoryAddress = "0xd66F1173cD44c15847a4e4E213A6245b5F1F82f3";
  const factory = await ethers.getContractAt("ElectionFactory", factoryAddress);
  
  // Get signer
  const [signer] = await ethers.getSigners();
  console.log("Testing with signer:", signer.address);
  
  try {
    // Construct test parameters
    const electionInfo = {
      startTime: BigInt("1759097471"),
      endTime: BigInt("1759183811"),
      name: "test",
      description: "123",
      isPrivate: true
    };
    
    const candidates = [
      { candidateID: BigInt(0), name: "qw", description: "as" },
      { candidateID: BigInt(1), name: "dfdf", description: "cv" }
    ];
    
    const ballotType = 1;
    const resultType = 1;
    
    const whitelist = [
      { identifier: "crunchypaan@gmail.com", identifierType: 0, isActive: true },
      { identifier: "literallyzk", identifierType: 1, isActive: true },
      { identifier: "0xf7d0a0de8a3abb3522be2e8ecf03ab99a2982d9c", identifierType: 4, isActive: true }
    ];
    
    console.log("Test parameters constructed successfully");
    
    // Try to estimate gas first
    console.log("\nâ›½ Estimating gas...");
    const gasEstimate = await factory.createPrivateElection.estimateGas(
      electionInfo,
      candidates,
      ballotType,
      resultType,
      whitelist,
      { value: ethers.parseEther("0.01") }
    );
    
    console.log("âœ… Gas estimate:", gasEstimate.toString());
    
  } catch (error) {
    console.error("âŒ Contract call failed:", error);
    console.error("Error data:", error.data);
    console.error("Error reason:", error.reason);
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });

